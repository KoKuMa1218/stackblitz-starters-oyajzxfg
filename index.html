<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LIFF Test: Push via Bot</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body { font-family: system-ui; padding: 16px; }
      pre { background:#f6f8fa; padding:12px; border-radius:8px; }
      .error { color:#c00; }
      .row { display:flex; gap:8px; margin:12px 0; flex-wrap:wrap; }
      button { padding:10px 14px; border-radius:8px; border:1px solid #ddd; cursor:pointer; }
    </style>
  </head>
  <body>
    <h1>LIFF Test: userId + QR params</h1>
    <pre id="out">กำลังเริ่มต้น...</pre>

    <div class="row">
      <button id="btnSendInChat" disabled>ส่งข้อความเข้าแชท/ห้องนี้ (LIFF)</button>

      <button id="btnPushViaBot" disabled>ส่งด้วยบอท (ผ่าน Backend)</button>

      <button id="btnSharePicker" disabled>ShareTargetPicker</button>
    </div>

    <p id="openInLineWrap" style="display:none">
      เปิดใน LINE: <a id="openInLineLink" href="#">คลิกที่นี่</a>
    </p>

    <script>
      const LIFF_ID = '2001836212-OMrmxm4E';  // ใส่ของคุณ
      const BACKEND_PUSH_URL = 'https://YOUR_BACKEND_HOST/api/push'; // <-- เปลี่ยนเป็นของคุณ

      let profile = null;
      let params = {};
      let ctx = null;

      async function sendInChat() {
        if (!liff.isInClient()) return alert('ต้องเปิดในแอป LINE');
        if (!ctx || ctx.type === 'none') return alert('ต้องเปิดจากในห้องแชท (context != none)');
        try {
          const txt =
            `แจ้งเตือนจาก LIFF\n` +
            `userId: ${profile.userId}\n` +
            `branch: ${params.branch || '-'}\n` +
            `campaign: ${params.campaign || '-'}\n` +
            `target: ${ctx.type} ${ctx.groupId ?? ctx.roomId ?? ''}`;
          await liff.sendMessages([{ type: 'text', text: txt }]);
          alert('ส่งสำเร็จด้วย LIFF');
        } catch (e) {
          alert('ส่งไม่สำเร็จ: ' + (e?.message || e));
          console.error(e);
        }
      }

      async function pushViaBot() {
        try {
          const payload = {
            branch: params.branch || null,
            campaign: params.campaign || null,
            userId: profile.userId || null,
            groupId: ctx?.groupId || null,
            roomId: ctx?.roomId || null,
            text:
              `แจ้งเตือนจาก Backend (Bot)\n` +
              `userId: ${profile.userId}\n` +
              `branch: ${params.branch || '-'}\n` +
              `campaign: ${params.campaign || '-'}`
          };
          const res = await fetch(BACKEND_PUSH_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.error || JSON.stringify(data));
          alert('สั่งบอท push สำเร็จ');
        } catch (e) {
          alert('เรียก Backend ไม่สำเร็จ: ' + (e?.message || e));
          console.error(e);
        }
      }

      async function sharePicker() {
        const ok = await liff.isApiAvailable('shareTargetPicker');
        if (!ok) return alert('เครื่องนี้ไม่รองรับ ShareTargetPicker');
        const text =
          `แจ้งเตือนจาก LIFF (ShareTargetPicker)\n` +
          `userId: ${profile.userId}\n` +
          `branch: ${params.branch || '-'}\n` +
          `campaign: ${params.campaign || '-'}`;
        try {
          const r = await liff.shareTargetPicker([{ type: 'text', text }]);
          if (r) alert('แชร์สำเร็จ');
        } catch (e) {
          alert('แชร์ไม่สำเร็จ: ' + (e?.message || e));
          console.error(e);
        }
      }

      (async () => {
        const out = document.getElementById('out');
        const btnSendInChat  = document.getElementById('btnSendInChat');
        const btnPushViaBot  = document.getElementById('btnPushViaBot');
        const btnSharePicker = document.getElementById('btnSharePicker');

        try {
          const url = new URL(location.href);
          params = Object.fromEntries(url.searchParams.entries());

          await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

          if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }

          profile = await liff.getProfile();
          ctx = liff.getContext();

          out.textContent = JSON.stringify({
            params, userId: profile.userId, displayName: profile.displayName,
            inClient: liff.isInClient(), context: ctx, os: liff.getOS(),
            language: liff.getLanguage(), version: liff.getVersion()
          }, null, 2);

          btnPushViaBot.disabled = false;          btnPushViaBot.onclick = pushViaBot;
          btnSharePicker.disabled = false;         btnSharePicker.onclick = sharePicker;

          if (liff.isInClient() && ctx?.type && ctx.type !== 'none') {
            btnSendInChat.disabled = false;        btnSendInChat.onclick = sendInChat;
          }

          if (!liff.isInClient()) {
            const link = document.getElementById('openInLineLink');
            const wrap = document.getElementById('openInLineWrap');
            const q = new URLSearchParams(params).toString();
            link.href = `https://liff.line.me/${LIFF_ID}${q ? '?' + q : ''}`;
            wrap.style.display = 'block';
          }
        } catch (e) {
          out.classList.add('error');
          out.textContent = 'Error: ' + (e?.message || e);
          console.error(e);
        }
      })();
    </script>
  </body>
</html>
