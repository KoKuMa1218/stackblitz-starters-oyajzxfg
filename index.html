<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LIFF Test on GitHub Pages / Stack</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body { font-family: system-ui; padding: 16px; }
      pre { background:#f6f8fa; padding:12px; border-radius:8px; }
      .error { color:#c00; }
      .row { display:flex; gap:8px; margin:12px 0; flex-wrap:wrap; }
      button { padding:10px 14px; border-radius:8px; border:1px solid #ddd; cursor:pointer; }
      .token-box { background:#fff; border:1px dashed #bbb; padding:10px; border-radius:8px; }
      .small { font-size:12px; color:#666; }
      .hint { color:#555; font-size:14px; }
    </style>
  </head>
  <body>
    <h1>LIFF Test: userId + QR params</h1>
    <pre id="out">กำลังเริ่มต้น...</pre>

    <div class="row">
      <button id="btnSendInChat" disabled>ส่งข้อความเข้าแชท/ห้องนี้</button>
      <button id="btnSharePicker" disabled>ส่งผ่าน ShareTargetPicker</button>
    </div>

    <div class="row">
      <button id="btnGrantScope" disabled>รับสิทธิ์ chat_message.write</button>
      <button id="btnReLogin" disabled>Re-login (เคลียร์สิทธิ์เดิม)</button>
    </div>
    <div id="ctxNote" class="hint"></div>

    <!-- โซน Access Token -->
    <div class="token-box">
      <div><strong>Access Token</strong> (<span class="small">กดแสดงเมื่อจำเป็นเท่านั้น</span>)</div>
      <div id="accessTokenMasked" style="margin:6px 0;">-</div>
      <div class="row">
        <button id="btnToggleToken" disabled>แสดง/ซ่อน</button>
        <button id="btnCopyToken" disabled>คัดลอก</button>
        <button id="btnVerifyToken" disabled>ส่งไปตรวจสอบที่ Backend</button>
      </div>
      <div class="small">แนะนำให้ใช้ ID Token/Access Token ตรวจสอบตัวตนฝั่งเซิร์ฟเวอร์ (OIDC / LINE Verify)</div>
    </div>

    <p id="openInLineWrap" style="display:none">
      เปิดใน LINE: <a id="openInLineLink" href="#">คลิกที่นี่</a>
    </p>

    <script>
      const LIFF_ID = '2001836212-OMrmxm4E'; // <-- LIFF ID ของคุณ
      const VERIFY_ENDPOINT = 'https://your-backend.example.com/verify'; // <-- เปลี่ยนเป็นของคุณ

      let cachedProfile = null;
      let cachedParams = {};
      let accessToken = null;
      let showToken = false;
      let ctx = null;

      function maskToken(t) {
        if (!t || t.length < 14) return '(hidden)';
        return t.slice(0, 8) + '…' + t.slice(-6);
      }

      async function sendInChat() {
        if (!liff.isInClient()) {
          alert('ต้องเปิดในแอป LINE ถึงจะใช้ส่งเข้าแชท/ห้องนี้ได้');
          return;
        }
        if (!ctx || ctx.type === 'none') {
          alert('ตอนนี้ context = none (ไม่ได้เปิดจากห้องแชท) ใช้ ShareTargetPicker หรือเปิดลิงก์จากในแชท');
          return;
        }

        const targetInfo = ctx.type + (ctx.groupId ? ' ('+ctx.groupId+')' : ctx.roomId ? ' ('+ctx.roomId+')' : '');
        const msgText =
          `แจ้งเตือนจาก LIFF\n` +
          `userId: ${cachedProfile?.userId}\n` +
          `branch: ${cachedParams.branch || '-'}\n` +
          `campaign: ${cachedParams.campaign || '-'}\n` +
          `target: ${targetInfo}`;

        try {
          await liff.sendMessages([{ type: 'text', text: msgText }]);
          alert('ส่งเข้าแชท/ห้องนี้สำเร็จ');
        } catch (e) {
          console.error(e);
          // ถ้า scope ยังไม่ได้รับ จะขึ้น permission error
          alert('ส่งไม่สำเร็จ: ' + (e?.message || e) + '\nกรุณากด "รับสิทธิ์ chat_message.write" แล้วลองใหม่');
        }
      }

      async function sharePicker() {
        const available = await liff.isApiAvailable('shareTargetPicker');
        if (!available) {
          alert('อุปกรณ์นี้ไม่รองรับ ShareTargetPicker');
          return;
        }
        const msgText =
          `แจ้งเตือนจาก LIFF (ShareTargetPicker)\n` +
          `userId: ${cachedProfile?.userId}\n` +
          `branch: ${cachedParams.branch || '-'}\n` +
          `campaign: ${cachedParams.campaign || '-'}`;

        try {
          const res = await liff.shareTargetPicker([{ type: 'text', text: msgText }]);
          if (res) alert('ส่งสำเร็จ');
        } catch (e) {
          console.error(e);
          alert('ส่งไม่สำเร็จ: ' + (e?.message || e));
        }
      }

      function refreshTokenUI() {
        const el = document.getElementById('accessTokenMasked');
        el.textContent = showToken ? (accessToken || '-') : maskToken(accessToken);
      }

      async function copyToken() {
        try {
          await navigator.clipboard.writeText(accessToken || '');
          alert('คัดลอก Access Token แล้ว');
        } catch {
          alert('คัดลอกไม่สำเร็จ');
        }
      }

      async function verifyTokenAtBackend() {
        try {
          const idToken = liff.getIDToken();
          const resp = await fetch(VERIFY_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              access_token: accessToken,
              id_token: idToken,
              liff_user_id: cachedProfile?.userId
            })
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(data?.error || JSON.stringify(data));
          alert('ตรวจสอบที่ Backend สำเร็จ: ' + JSON.stringify(data));
        } catch (e) {
          console.error(e);
          alert('Backend verify ล้มเหลว: ' + (e?.message || e));
        }
      }

      (async () => {
        const out = document.getElementById('out');
        const note = document.getElementById('ctxNote');

        const btnSendInChat   = document.getElementById('btnSendInChat');
        const btnSharePicker  = document.getElementById('btnSharePicker');
        const btnGrantScope   = document.getElementById('btnGrantScope');
        const btnReLogin      = document.getElementById('btnReLogin');

        const btnToggleToken  = document.getElementById('btnToggleToken');
        const btnCopyToken    = document.getElementById('btnCopyToken');
        const btnVerifyToken  = document.getElementById('btnVerifyToken');

        try {
          const url = new URL(location.href);
          cachedParams = Object.fromEntries(url.searchParams.entries());

          await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

          if (!liff.isLoggedIn()) {
            // ขอสิทธิ์ให้ครบตั้งแต่แรก (รวม chat_message.write)
            liff.login({
              redirectUri: location.href,
              scope: ['profile','openid','chat_message.write'],
              prompt: 'consent'
            });
            return;
          }

          cachedProfile = await liff.getProfile();
          accessToken   = liff.getAccessToken();
          ctx           = liff.getContext();

          const payload = {
            params: cachedParams,
            userId: cachedProfile.userId,
            displayName: cachedProfile.displayName,
            inClient: liff.isInClient(),
            context: ctx,  // type: "group"/"room"/"utou"/"none"
            os: liff.getOS(),
            language: liff.getLanguage(),
            version: liff.getVersion(),
            accessTokenHash: ctx?.accessTokenHash || null
          };
          out.textContent = JSON.stringify(payload, null, 2);

          // Messaging buttons
          btnSharePicker.disabled = false;
          btnSharePicker.addEventListener('click', sharePicker);

          if (liff.isInClient() && ctx?.type && ctx.type !== 'none') {
            btnSendInChat.disabled = false;
            btnSendInChat.addEventListener('click', sendInChat);
            note.textContent = `context = ${ctx.type} (สามารถส่งเข้าแชท/ห้องนี้ได้)`;
          } else {
            btnSendInChat.disabled = true;
            note.textContent = `context = none (ส่งเข้าแชทไม่ได้ — ให้เปิดลิงก์จากในห้องแชท หรือใช้ ShareTargetPicker)`;
          }

          // Scope helper buttons
          btnGrantScope.disabled = false;
          btnGrantScope.addEventListener('click', () => {
            // ขอสิทธิ์ใหม่แบบบังคับ consent อีกครั้ง
            liff.login({
              redirectUri: location.href,
              scope: ['profile','openid','chat_message.write'],
              prompt: 'consent'
            });
          });

          btnReLogin.disabled = false;
          btnReLogin.addEventListener('click', () => {
            liff.logout();
            location.replace(location.href); // เคลียร์เซสชันแล้วโหลดใหม่
          });

          // Token buttons
          btnToggleToken.disabled = false;
          btnCopyToken.disabled   = !accessToken;
          btnVerifyToken.disabled = !accessToken;

          btnToggleToken.addEventListener('click', () => { showToken = !showToken; refreshTokenUI(); });
          btnCopyToken.addEventListener('click', copyToken);
          btnVerifyToken.addEventListener('click', verifyTokenAtBackend);
          refreshTokenUI();

          // ลิงก์เปิดใน LINE (กรณีอยู่นอกแอป)
          if (!liff.isInClient()) {
            const link = document.getElementById('openInLineLink');
            const wrap = document.getElementById('openInLineWrap');
            const q = new URLSearchParams(cachedParams).toString();
            link.href = `https://liff.line.me/${LIFF_ID}${q ? '?' + q : ''}`;
            wrap.style.display = 'block';
          }
        } catch (e) {
          out.classList.add('error');
          out.textContent = 'Error: ' + (e?.message || e);
          console.error(e);
        }
      })();
    </script>
  </body>
</html>
